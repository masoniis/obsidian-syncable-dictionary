name: Create plugin release

on:
  push:
    tags: # Trigger on push of any new tag
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Build plugin
        run: |
          bun install
          bun run build

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract the tag name from the GITHUB_REF
          # GITHUB_REF is in the format refs/tags/your-tag-name
          TAG_NAME="${GITHUB_REF#refs/tags/}"

          echo "Creating release for tag: $TAG_NAME"

          # Check if release notes file exists, create a dummy one if not
          # You might want to name your release notes file based on the tag, e.g., release-notes-$TAG_NAME.md
          # Or have a generic one that you update before tagging.
          RELEASE_NOTES_FILE="release-notes.md"
          if [ ! -f "$RELEASE_NOTES_FILE" ]; then
            echo "Release notes ($RELEASE_NOTES_FILE) not found. Creating a placeholder."
            echo "# Release $TAG_NAME" > "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            echo "Automated release for tag $TAG_NAME." >> "$RELEASE_NOTES_FILE"
            echo "Files included: main.js, manifest.json, styles.css (if they exist)" >> "$RELEASE_NOTES_FILE"
          fi

          # Prepare list of assets, checking if they exist
          ASSETS=""
          if [ -f "main.js" ]; then
            ASSETS="$ASSETS main.js"
          else
            echo "Warning: main.js not found. It will not be included in the release."
          fi

          if [ -f "manifest.json" ]; then
            ASSETS="$ASSETS manifest.json"
          else
            echo "Warning: manifest.json not found. It will not be included in the release."
          fi

          if [ -f "styles.css" ]; then
            ASSETS="$ASSETS styles.css"
          else
            echo "Warning: styles.css not found. It will not be included in the release."
          fi

          if [ -z "$ASSETS" ]; then
            echo "No assets found (main.js, manifest.json, styles.css). Cannot create release."
            exit 1
          fi

          # Create the GitHub release using the tag
          gh release create "$TAG_NAME" \
            --title="$TAG_NAME" \
            --notes-file="$RELEASE_NOTES_FILE" \
            $ASSETS # Add the asset files that exist
